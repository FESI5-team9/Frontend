#!/bin/sh

# Get the commit message file path
COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# Get current branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)

# Extract JIRA ticket number from branch name (format: ABC-123-branch-description)
ISSUE_TICKET=$(echo "$BRANCH_NAME" | grep -o -E '^[A-Z]+-[0-9]+' || true)

# Only proceed if we found a JIRA ticket and this is not a merge commit
if [ -n "$ISSUE_TICKET" ] && [ -z "$COMMIT_SOURCE" ]; then
    # Read existing commit message
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
    
    # Check if commit message already starts with the JIRA ticket
    if ! echo "$COMMIT_MSG" | grep -q "^$ISSUE_TICKET"; then
        # Prepend the JIRA ticket if it's not already there
        echo "$ISSUE_TICKET: $COMMIT_MSG" > "$COMMIT_MSG_FILE"
    fi
fi

exit 0